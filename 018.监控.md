# 监控

## 单机监控

[Linux命令手册](http://lnmp.ailinux.net/)，此手册不再维护top命令，查看htop

1. CPU监控命令：w、top、htop、glances

```shell
%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  0.2 si,  0.2 st
    us：用户态，一般情况下用户态的CPU占比应在30~35%
    sy：系统态，一般情况下用户态的CPU占比应在60~65%
    id：空闲CPU
```

top子命令：

- 数字键1 —— 查看每个CPU核心的使用率（间接判断主机总共有多少CPU核心）
- m键 —— 切换内存占用率的显示方式（文字、条形）

htop是top工具的升级版，glances能够非常直观的看到CPU的使用占比

2. 内存监控命令：free、top、glances、htop，关注内存的使用情况
3. 磁盘监控命令：iotop、iostat、dstat、glances，关注inode、block、读写速率
4. 网络监控命令：glances、iftop、nethogs（查看具体进程占用的网络带宽量）

iftop子命令：p键展示协议端口信息

5. 进程监控命令：top
6. TCP状态监控命令：netstat、ss

`ss -an | awk '{print $2}' | sort | uniq -c`统计当前系统上的TCP状态连接，CentOS7版本以后建议使用ss命令，因为netstat命令使用遍历的方式读取/proc/下的进程信息并展示，假设卸载/proc/目录，netstat命令就无法检索出信息，而ss命令则不受影响

7. shell脚本监控内存使用状态

```shell

[root@web01 ~]# more /opt/memory_check.sh
#!/bin/bash
#filename: /opt/memory_check.sh
#description: check free memory

# 定义变量
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin"
free_memory=$(free -m | awk '/Mem/{print $NF}')
hostname=$(hostname)_$(hostname -I | awk '{print $2}')
date=$(date +%F)

# 判断条件
if [ $free_memory -gt 100 ]; then
        exit;
fi

# 内存小于100触发告警
echo "${date}_${hostname}: 内存不足！目前可用内存${free_memory}MB"
```

使用命令`dd if=/dev/zero of=/dev/null bs=800M`模拟内存不够的场景，查看脚本执行结果

## Zabbix

单节点直接使用命令监控系统状态、多节点使用shell脚本监控系统，此两者都无需使用监控工具，使用监控工具反倒会占用部分系统资源。而大量设备场景下需要借助监控工具，更好管理设备

### Zabbix二进制包安装

1. 安装zabbix的yum源

```shell
[root@zabbix-server ~]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
```

注：CentOS7仅支持安装zabbix5.0版本。[zabbix5.0安装手册](https://www.zabbix.com/cn/download?zabbix=5.0&os_distribution=centos&os_version=7&components=server_frontend_agent&db=mysql&ws=nginx)

