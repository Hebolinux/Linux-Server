# 017.Nginx性能优化

## 性能优化概述

基于Nginx的性能优化首先需要对系统和Nginx当前的运行状态做一个信息收集，例如了解当前系统的结构和瓶颈，了解当前系统运行的业务、服务，单个服务能够支撑多大并发、最高瓶颈是多少、支持多少qps（每秒查询率）的访问请求，通过一些系统监控工具和压力测试工具，获取当前系统架构能够承受多少的请求和并发，基于此数据做相应的性能评估和优化方向

其次需要了解业务模式，每一个性能优化的目的都是为业务提供服务，所以需要了解业务接口的类型、系统层次化的结构，比如电商网站的抢购模式，只会在某一段时间内流量突增、比如Nginx所代表的角色，是代理、动静分离还是后端服务，针对不同的场景提供不同的优化方向

最后需要考虑性能和安全的对比，性能与安全在一定程度上是对立的，安全检测严密会对性能产生影响，过度追求性能会导致安全隐患，所以设计防火墙功能时必须平衡好两者的关系

## 压力测试工具

在系统业务量没有增长前就需要做好相应准备，以防范业务量突增带来的接口压力，因此对于业务接口的压力测试就显得非常重要，在业务上线之前就需要先对业务接口进行请求和并发的测试。管理员需要对系统能够承受的压力有一个评估，然后通过工具检测系统是否能够满足对应压力的需求

1. 安装ab压力测试工具

```shell
[root@web01 ~]# yum install -y httpd-tools
```

2. ab压测工具的使用方式

```shell
ab -n 200 -c 2 http://127.0.0.1/
    -n：总的请求次数
    -c：并发请求数
    -k：是否开启长链接
    -s：最大超时时间，默认30s
```
3. 安装tomcat

```shell
[root@web01 ~]# yum install -y java
[root@web01 ~]# wget --no-check-certificate https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.73/bin/apache-tomcat-9.0.73.tar.gz
[root@web01 ~]# tar -xzf apache-tomcat-9.0.73.tar.gz
[root@web01 ~]# mv apache-tomcat-9.0.73 /usr/local/tomcat
[root@web01 ~]# /usr/local/tomcat/bin/startup.sh    # 启动tomcat
```

yum安装的java版本较低，只能配合tomcat9，tomcat10会因为java版本问题启动失败

4. 配置Nginx静态网站与tomcat动态网站环境

```shell
[root@web01 ~]# vim /usr/local/nginx/conf.d/ab.example.com.conf
server {
    server_name ab.example.com;
    listen 80;
    location / {
        root /usr/local/nginx/html/;
        index index.jsp index.html;
        try_files $uri @java_page;
    }
    location @java_page {
        proxy_pass http://127.0.0.1:8080;
    }
}
[root@web01 ~]# echo "Nginx Ab Load" > /usr/local/nginx/html/test7.html
[root@web01 ~]# echo "Tomcat Ab Load" > /usr/local/tomcat/webapps/ROOT/test7.html
```

5. Nginx站点压力测试

```shell
[root@web01 ~]# curl http://127.0.0.1/test7.html    # 查看当前是Nginx站点还是Tomcat站点
[root@web01 ~]# ab -n10000 -c200 http://127.0.0.1/test7.html
...
Server Software:        nginx/1.22.1
Server Hostname:        127.0.0.1
Server Port:            80

Document Path:          /test7.html
Document Length:        14 bytes

Concurrency Level:      200     请求并发数
Time taken for tests:   2.260 seconds       处理完所有请求所用的总时长
Complete requests:      10000       总请求数
Failed requests:        0       失败的请求数
Write errors:           0       
Total transferred:      2630000 bytes       总传输大小
HTML transferred:       140000 bytes        HTML传输字节大小
Requests per second:    4423.96 [#/sec] (mean)      QPS，每秒请求数，意味着每秒需要处理多少请求
Time per request:       45.208 [ms] (mean)      客户端请求服务端时，每个请求需要耗费的时间
Time per request:       0.226 [ms] (mean, across all concurrent requests)       服务端处理客户端请求时，每个请求的处理时间
Transfer rate:          1136.23 [Kbytes/sec] received       传输速率
...

# 将html文件移走后再测试
[root@web01 ~]# mv /usr/local/nginx/html/test7.html /opt/
[root@web01 ~]# ab -n10000 -c200 http://127.0.0.1/test7.html
...
Non-2xx responses:      10000       # 测试结果多出一行非200系列响应码，请求回应总数
...
```

6. Tomcat站点压力测试

在测试Tomcat站点前，必须将Nginx站点的html文件移走，否则用户请求仍会由Nginx解析

```shell
[root@web01 ~]# curl http://127.0.0.1/test7.html    # 确保此时是Tomcat站点反馈
[root@web01 ~]# ab -n10000 -c200 -k http://127.0.0.1/test7.html
Server Software:        nginx/1.22.1
Server Hostname:        127.0.0.1
Server Port:            80

Document Path:          /test7.html
Document Length:        15 bytes

Concurrency Level:      200
Time taken for tests:   70.185 seconds
Complete requests:      10000
Failed requests:        208
   (Connect: 0, Receive: 0, Length: 76, Exceptions: 132)
Write errors:           0
Total transferred:      2700000 bytes
HTML transferred:       150000 bytes
Requests per second:    142.48 [#/sec] (mean)
Time per request:       1403.696 [ms] (mean)
Time per request:       7.018 [ms] (mean, across all concurrent requests)
Transfer rate:          37.57 [Kbytes/sec] received

[root@web01 ~]# ss -an  # 在压力测试下查看端口信息
```

Tomcat站点测试需要设置超时时间或长链接，否则ab命令可能会因为超时报错。在长链接场景下会产生大量的TIME_WAIT状态，每个TIME_WAIT都会占用一个端口，在大量请求、高并发的情况下，站点可能会因为端口用尽而无法响应用户请求；对比Nginx和Tomcat的测试可以非常明显观察到，Nginx的静态资源响应速率远超Tomcat

## 系统性能优化

Linux中所有资源都以文件的形式存在，比如消息、共享内存、连接等，句柄可以理解为指向这些文件的指针。文件句柄会随着进程的调用频繁增加，系统默认文件句柄是有限制的，不能让一个进程无限制的调用，所以管理员需要限制每个进程和每个服务使用多大的句柄，此为必要的优化调整参数。文件句柄有3种设置方式：系统全局修改、用户局部修改、进程局部修改

```shell
[root@web01 ~]# ulimit -a   # 查看单个进程可打开的句柄上限
[root@web01 ~]# ulimit -a PID    # 查看某个进程的句柄上限
[root@web01 ~]# ulimit -n   # 查看系统设置的最大文件句柄数

# 针对root用户，soft仅提醒，hard限制，nofile打开最大文件数
[root@web01 ~]# vim /etc/security/limits.conf
root soft nofile 65535
root hard nofile 65535

# *代表所有用户
[root@web01 ~]# vim /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535
* - nofile 65535    # -代表soft和hard两者兼具

# 针对Nginx进程
[root@web01 ~]# vim /usr/local/nginx/conf.d/ab.example.com.conf
worker_rlimit_nofile 65535  # 在nginx核心模块加入此选项
```

使用lsof监控文件描述符数量

```shell
[root@web01 ~]# lsof -i :80 # 查看监听80端口的进程
[root@web01 ~]# lsof -p $(more /usr/local/nginx/nginx.pid) | wc -l  # 统计nginx打开的文件描述符

# ab压力测试的同时检测nginx的worker进程占用的文件描述符数量
[root@web01 ~]# ab -k -n 10000 -c 200 http://127.0.0.1/test7.html
[root@web01 ~]# lsof -p 663 | wc -l
```

调整内核参数，使time_wait状态端口复用

```shell
[root@web01 ~]# vim /etc/sysctl.conf
...
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_timestamps = 1 # 打开时间戳
...
[root@web01 ~]# sysctl -p   # 查看管理员手动添加的内核参数
[root@web01 ~]# sysctl -a   # 查看系统设置的默认的内核参数
```

## 代理服务优化

通常Nginx作为代理服务负责转发用户请求，那么转发的过程中开启HTTP长链接，能够减少握手次数、降低服务器损耗

1. 长链接语法示例（应用层优化）

```shell
Syntax: keepalive connections;
Default: -
Context: upstream
This directive appeared in version 1.1.4
```

2. 配置Nginx代理服务使用长链接方式

```shell

```