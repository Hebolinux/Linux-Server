# Nginx常用模块

## autoindex

ngx\_http\_autoindex\_module模块处理以斜杠字符‘/’结尾的请求，并生成目录列表。当ngx\_http\_autoindex\_module模块找不到index索引文件时，通常会将请求传递给autoindex模块

1. 指令

```shell
# 1.autoindex激活/关闭
syntax: autoindex on | off;
default: autoindex off;     # 默认关闭autoindex
context: http, server, location     # 可以放在http{}、server{}、location{}层级内

# 2.设置索引时文件大小的单位（B、KB、MB或GB）
Syntax: autoindex_exact_size [ on|off ]
Default: autoindex_exact_size on        # 默认打开，以字节方式展示
Context: http, server, location

# 3.开启以本地时间来显示文件时间的功能
syntax: autoindex_localtime [ on|off ]
default: autoindex_localtime off
context: http, server, location
```

2. 示例

```shell
[root@web01 ~]# vim /etc/nginx/conf.d/autoindex.conf
server {
        listen 80;
        server_name web01.example.com;
        charset utf-8,gbk;      # 设置字符集，解决中文乱码问题

        location / {
                root /usr/share/nginx/html/;
                # index index.html index.htm;
                autoindex on;       # 启用autoindex模块
        }
}
```

想要实现展示为目录列表，需要将index.html索引文件移除，或者在配置文件中将index行注释，浏览器在展示目录列表中的文件时，浏览器无法解析的文件会默认为下载类型，能够解析的文件会直接展示

3. 扩展示例

```shell
# 1.在宿主机上挂载iso镜像文件，然后开启NFS，给web01挂载
[root@hebor ~]# mount /dev/cdrom /mnt/nfs/
[root@hebor ~]# vim /etc/exports
/mnt/nfs	172.16.1.0/24(rw,sync,all_squash)
[root@hebor ~]# firewall-cmd --add-service=nfs --permanent
[root@hebor ~]# firewall-cmd --add-service=mountd --permanent
[root@hebor ~]# firewall-cmd --add-service=rpc-bind --permanent
[root@hebor ~]# firewall-cmd --reload
[root@web01 ~]# mount -t nfs hebor:/mnt/nfs /usr/share/nginx/html/      # 在web01上挂载nfs

# 2.编辑nginx配置文件
[root@web01 ~]# vim /etc/nginx/conf.d/demo1.conf
server {
        listen 80;
        server_name web01.example.com;
        charset utf-8,gbk;

        location / {
                root /opt/code/;
                index index.html index.htm;
        }

        location /iso {
                alias /usr/share/nginx/html/;       # nfs镜像挂载点
                autoindex on;
                autoindex_exact_size off;
                autoindex_localtime on;
        }
}
```

此配置文件实现了，用户访问`http://web01.example.com/`时，能够正常访问到web主页，访问iso子页时`http://web01.example.com/iso`能够直接访问iso镜像文件

### 关于root和alias关键词

```shell
location / {        # 示例1
        root /opt/code/;
}

location /iso {     # 示例2
        alias /usr/share/nginx/html/;
}
```

以此配置文件为例，示例1中location关键词定义‘/’，root关键词定义`/opt/code/`，这代表用户访问‘/’时，nginx会从`/opt/code/`目录下返回默认的index.html文件到用户，如果此时`/opt/code/`目录下没有index.html文件，nginx会返回403错误

示例2将root关键词替换为alias关键词，location定义‘/’下的‘iso’路径，这代表用户访问‘/iso’时，nginx会从`/usr/share/nginx/html/`目录下返回index.html文件到用户。看起来没什么问题，那么将alias替换回root会发生什么？用户访问‘/iso’时，nginx会从`/usr/share/nginx/html/iso/`目录下返回index.html文件到用户，而此时服务器上并没有`/usr/share/nginx/html/iso/`这个路径，nginx会返回404错误

所以，location关键词定义的‘/’就代表root关键词定义的路径，一旦在localtion定义的‘/’下追加路径，例如`/iso`，那么该路径也会被追加到root定义的路径后面，例如`/usr/share/nginx/html/iso/`，nginx只会从root路径下去找index索引文件，一旦访问的页面不是自己想要的页面时，需要检查配置文件

而使用alias关键词时，无论location关键词定义的路径是什么，nginx最终都会跳转到alias定义的路径下返回index索引文件。**location定义的路径，是用户访问的路径；root或alias定义的路径，是nginx访问的路径**

## stub_status

ngx\_http\_stub\_status\_module模块提供对基本信息的访问，它不是核心模块，安装nginx时需要手动添加编译参数`--with-http_stub_status_module`才能启用它，yum安装默认携带有这个模块

1. 指令

```shell
Syntax: stub_status on
Default: None
Context: server, location
```

2. 示例

```shell
[root@web01 ~]# vim /etc/nginx/conf.d/demo1.conf
...
location /nginx_status {        # 默认会创建一个简单的网页，用于展示基本数据
                stub_status;
        }
...
```

在1.7.5之前的版本中，指令语法需要任意参数，例如`stub_status on`

```shell
Active connections: 1
server accepts handled requests
 1 1 1
Reading: 0 Writing: 1 Waiting: 0

Active connections  # 当前活动客户端的连接数，包括Waiting等待连接数
accepts     # 已接受的总TCP连接数
handled     # 已处理的TCP连接数。总TCP减去已处理TCP数的就是丢弃的TCP数量
requests    # 客户端总的http请求数
Reading     # 当前nginx读取请求头的连接数
Writing     # 当前nginx将响应写回客户端的连接数
Waiting     # 当前等待请求的空闲客户端连接数
```

一次TCP连接可以发起多次http请求，通过修改主配置文件`/etc/nginx/nginx.conf`的参数可配置进行验证

- keepalive_timeout 0;    # 类似关闭长连接
- keepalive_timeout 65;   # 65s没有活动则断开连接

## access

ngx\_http\_access\_module模块允许限制对某些客户端地址的访问

1. 指令

```shell
# 1.允许语法
Syntax: allow address| CIDR| unix:| all;
Default: -
Context: http, server, location, limit_except

# 2.拒绝语法
Syntax: deny address| CIDR| unix:| all;
Default: -
Context: http, server, location, limit_except
```

2. 示例

```shell
[root@web01 ~]# vim /etc/nginx/conf.d/demo1.conf
...
location /nginx_status {
                stub_status;
                deny 172.16.1.7/32;     # 禁止web01本机访问状态页面
                allow all;
        }
...
```

此时web01本机访问提示403权限错误。access模块与ACL基本一致，从上到下逐一匹配规则，使用IP地址对来源客户做限制存在弊端，客户端能够使用代理的方式突破IP限制。一般nginx状态页只允许本机的127.0.0.1回环地址访问，其他地址都无法访问

## basic_auth

ngx\_http\_auth\_basic\_module模块允许通过使用HTTP基本认证协议验证用户名和密码来限制对资源的访问，访问也可以受地址，子请求的结果或JWT的限制，通过地址和密码同时限制访问受到满足指令的控制

ngx\_http\_auth\_basic\_module模块使用的密码文件的格式是`name:password`，且密码必须是加密后生成的字符串，可以使用htpasswd或openssl passwd生成密码

1. 指令

```shell
# 1.定义开启/关闭账号验证
Syntax: auth_basic string | off;
Default: auth_basic off;
Context: http, server, location, limit_except

# 2.保存账号密码的文件路径
Syntax: auth_basic_user_file file_path;
Default: -
Context: http, server, location, limit_except
```

2. 示例

```shell
[root@web01 ~]# htpasswd -c -b /etc/nginx/auth_conf hebor redhat        # 生成密码文件
    # -c：create创建密码文件
    # -b：在命令行输入账户/密码。默认以交互式输入密码
[root@web01 ~]# vim /etc/nginx/conf.d/demo1.conf
...
location /iso {
        alias /usr/share/nginx/html/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        auth_basic "download file";
        auth_basic_user_file /etc/nginx/auth_conf;
}
...
```

`auth_basic_file_file`路径也可以使用相对路径，直接写auth\_conf即可，默认nginx会到它的安装路径下查找auth\_conf文件。使用htpasswd生成密码文件，一个密码文件对应一个nginx配置文件

## limit_conn

ngx\_http\_limit\_conn\_module模块用于限制每个定义密钥的连接数量，特别是来自单个IP地址的连接数量，并非所有的连接都被计数，只有在服务器处理了请求并且已经读取了整个请求头时才计算连接。这个模块配合ngx\_http\_limit\_req\_module可以用于解决服务器流量异常和负载过大的情况，对于大流量的恶意访问带来的带宽浪费，可以考虑针对IP的连接数、请求数进行限制

1. 指令

```shell
# 1.定义一个‘域’名
Syntax: limit_conn_zone key zone=name:number;   # 开辟一个新的内存空间用于存储关键字key的信息，给这个空间命名name，空间大小设置为number
Default: -
Context: http

# 2.调用定义的‘域’
Syntax: limit_conn zone number;     # 限制同时最高支持number个连接
Default: -
Context: http, server, location
```

2. 示例

```shell
# 1.在http层下添加limit_conn_zone
[root@web01 ~]# vim /etc/nginx/nginx.conf
...
# 此配置表示定义一个10M空间用于存储客户端IP信息，并为此空间命名为conn_zone
limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
...

# 2.在server层调用conn_zone
[root@web01 ~]# vim /etc/nginx/conf.d/demo1.conf
...
location / { 
        root /opt/code/;
        index index.html index.htm;
        limit_conn conn_zone 1;     # 测试配置，限制同一时间最高支持1个连接
}
...

# 3.压力测试
[root@web01 ~]# tail -f /var/log/nginx/error.log    # 服务端持续监控错误日志
[root@hebor ~]# ab -n 20 -c 2 http://172.16.1.7/index.html
        -n：总连接数
        -c：并发连接数
```

$binary\_remote\_addr也可以修改为其他关键词，例如$remote\_addr，$binary\_remote\_addr比$remote\_addr占用更少的字节。压力测试过程中会有许多请求访问失败并收到http响应码503，nginx错误日志中会记录这些错误信息，同时，已经连接上nginx的1个连接，仍然可以对Web页面中的任何子页面进行访问，因为http 1.1的特性，一次TCP连接可以发起多次请求

## limit_req

ngx\_http\_limit\_req\_module模块用于限制key的请求的处理速率，特别是从单个IP地址的请求的处理速率

1. 指令

```shell
# 1.定义语法
Syntax: limit_req_zone key zone=name:size rate=rate [sync];     # rate表示传输速率
Default: —
Context: http

# 2. 调用语法
Syntax: limit_req zone=name [burst=number] [nodelay | delay=number];
Default: —
Context: http, , serverlocation
```

2. 示例

```shell

```

## limit_req-2

## location