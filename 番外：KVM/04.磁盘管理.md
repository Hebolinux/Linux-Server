# KVM存储

KVM必须配置一个作为存储磁盘镜像（存储卷）的目录，这个目录称为存储池。KVM的默认存储池是`/var/lib/libvirt/images`

## 存储池管理

示例：新建存储池

```shell
# 1.创建作为存储池的新目录
mkdir /mnt/vmfs/ -p

# 2.定义存储池与其目录
virsh pool-define-as vmdisk --type dir --target /mnt/vmfs

# 3.创建已定义的存储池
virsh pool-build vmdisk

# 4.查看已定义的存储池，存储池不激活无法使用
virsh pool-list --all

# 5.激活已定义的存储池
virsh pool-start vmdisk
```

示例：存储池管理相关命令

```shell
# 1.在存储池中创建虚拟机存储卷
virsh vol-create-as vmdisk oeltest03.qcow2 20G --format qcow2

# 2.从存储池中删除虚拟机存储卷
virsh vol-delete --pool vmdisk oeltest03.qcow2

# 3.取消激活存储池
virsh pool-destroy vmdisk

# 4.删除存储池
virsh pool-delete vmdisk

# 5.取消定义存储池
virsh pool-undefine vmdisk
```

KVM存储池主要是体现一种管理方式，可以通过挂载存储目录、LVM逻辑卷的方式创建存储池，通过存储池来管理下一级的存储卷，也便于KVM的虚拟机迁移任务

## 磁盘格式

### 1. 磁盘镜像文件格式

- raw：原始格式，性能最好，但raw不具备其他功能
- qcow：读写性能不如raw，功能不如qcow2
- qcow2：及各种技术为一体的超级镜像格式，支持内部快照、加密、压缩等功能，读写性能也在提高中
- qed：基本不用

KVM默认安装好用的是raw格式，如果要做快照就要转换成qcow2格式。使用raw镜像文件时，raw会立刻分配所有空间，qcow2只会在需要使用到空间的时候才会分配空间，能够有效避免空间浪费

### 2. 创建磁盘文件

```shell
# 1.创建qcow2格式磁盘文件
qemu-img create -f qcow2 /var/lib/libvirt/images/test.qcow2 20G

# 2.创建raw格式磁盘文件
qemu-img create -f raw /var/lib/libvirt/images/test.img 2G

# 3.查看已创建的虚拟磁盘文件
qemu-img info /var/lib/libvirt/images/test.img
```