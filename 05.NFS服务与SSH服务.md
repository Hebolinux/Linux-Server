# NFS

NFS存储在集群中用于保存静态资源数据。NFS主要功能是通过*局域网络*在不同主机间共享文件，用于企业集群架构中，如果是大型网站，会用到更复杂的分布式文件系统FastDFS（4K~500M的小文件，音频、小说、视频），Glusterfs（大文件，iso镜像），HDFS

NFS解决了web静态资源的一致性和共享，避免web服务器的磁盘空间浪费，但它不能解决网站访问的延时问题，甚至会扩展大这个问题

## NFS写入原理

[![NFS写入原理](https://s1.ax1x.com/2022/11/26/zNiudK.png)](https://imgse.com/i/zNiudK)

NFS服务端本地写入，当用户执行mkdir命令，该命令会调用shell解释器翻译给内核，内核解析完成后驱动对应的硬件设备

NFS远程写入实现过程

1. 用户进程访问NFS客户端，使用不同的函数封装不同的操作命令
2. NFS客户端通过TCP/IP协议传输数据到NFS服务端
3. NFS服务端接收请求后，会先调用portmap进程进行端口映射
4. nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端
5. Rpc.mount进程判断客户端是否有具备文件的操作权限
6. idmap进程实现用户的映射和压缩
7. 最后NFS服务端会将对应请求的函数解封装转换为本地能识别的命令，传递至内核，由内核驱动硬件

从NFS的远程写入过程中，无论客户端操作系统是什么操作系统平台并不重要，客户端的命令首先都需要交给函数进行封装，函数传输到服务端后再进行识别；rpc是一个远程过程调用，使用nfs必须有rpc服务

- Rpc.nfsd：基本的NFS守护进程，主要功能是管理客户端是否能够登录服务器
- Rpc.mount：主要功能是管理NFS的文件系统。当客户端顺利通过nfsd登录NFS服务器后，在使用NFS服务所提供的文件签，还必须通过文件使用权限的验证。它会读取NFS的配置文件/etc/exports来对比客户端权限
- Portmap：主要功能是进行端口映射工作，其本身默认监听111端口

## NFS服务安装

1. 安装

```shell
[root@nfs ~]# yum install -y nfs-utils	# rpc包会被作为nfs的依赖包一起安装
[root@nfs ~]# rpm -qa rpcbind		# 检查rpc包
[root@nfs ~]# systemctl status rpcbind	# rpc安装后默认会设置为开机自启
```

2. 配置

NFS主配置文件`/etc/exports`，NFS配置文件语法格式：`共享目录 NFS客户端地址(客户端权限)`

示例：将nfs服务端的`/data`目录共享给`172.16.1.0/24`网段的所有主机

1. 所有客户端主机都具备读写权限
2. 将数据写入NFS服务器的硬盘中后才会结束操作，最大限度保证数据不丢失
3. 将所有用户映射为本地的匿名用户（nfsnobody）

```shell
[root@nfs ~]# more /etc/exports
/data	172.16.1.0/24(rw,sync,all_squash)

[root@nfs ~]# mkdir /data
[root@nfs ~]# firewall-cmd --add-service=nfs --permanent
[root@nfs ~]# firewall-cmd --add-service=rpc-bind --permanent
[root@nfs ~]# firewall-cmd --add-service=mountd --permanent
[root@nfs ~]# firewall-cmd --reload
```

3. 启动

```shell
systemctl start nfs-server
systemctl enable nfs-server
```

4. 检测

NFS服务启动后，`/var/lib/nfs/etab`内会记录NFS的共享配置信息，如果此文件为空，则配置文件可能有误，查看此文件时能看到大量权限参数，除了手动配置的参数以外，其他的参数都是NFS默认添加的

```shell
[root@nfs ~]# more /var/lib/nfs/etab
[root@nfs ~]# ss -lntp | column -t	# 查看端口
```

5. 客户端挂载

NFS通过RPC协议进行交互，所以客户端也必须具备rpcbind服务，除此以外，nfs-utils包中仍包含一些客户端要使用到的命令，例如showmount等

```shell
[root@web01 ~]# yum install -y nfs-utils
[root@web01 ~]# showmount -e 172.16.1.31	# 检查是否存在共享内容
[root@web01 ~]# mount -t nfs 172.16.1.31:/data /opt
[root@web01 ~]# df -h	# 查看挂载
```

此时NFS客户端连接挂载完毕，但客户端往共享目录里写入数据时会提示权限错误，客户端连接服务端的时候会经过两层验证，nfsd会检测客户端是否能够连接成功，mount会检测客户端对共享目录的权限。在上例中，mount的权限是rw，这两个检测都没有问题，因此，提示权限错误是由于主配置文件中，客户端的另一个权限参数all_squash导致

all_squash参数表示将所有客户端的用户压缩成一个匿名用户，这个匿名用户的uid和gid都是65534（nfsnobody)。所以，任何一个客户端的指令到达服务端后，都会被NFS服务交给这个匿名用户进行接封装再执行，但由于服务端的共享目录是由root创建，所以匿名用户没有权限操作共享目录，重新更改共享目录的授权即可。关于匿名用户的信息，在`/var/lib/nfs/etab`文件中也有记录