# Nginx动静分离

动静分离是指通过各种中间件技术，将用户的动态请求与静态请求分离，静态请求的资源能够直接通过中间件返回到客户端，以减少不必要的资源开销和请求延时；动静分离只有好处，即便动态服务不可用，静态资源仍不会收到影响

## 单节点动静分离

![Nginx单节点动静分离](https://www.z4a.net/images/2023/03/08/Nginx.png)

此前的nginx配置没有做到真正的动静分离，`\.php$`匹配最终都交给了PHP程序进行处理，由PHP返回资源到用户，即便是由`/`匹配到的index.php也仍由PHP程序处理，再返回图片到用户。此示意图中，负载均衡节点不是必须的，只不过通过负载均衡更便于查看测试结果

|节点|服务|
|---|---|
|lb01|Nginx Proxy|
|web01|Nginx Static|
|web02|Tomcat Server|

1. 在web01上配置静态资源

```shell
[root@web01 ~]# vim /usr/local/nginx/conf.d/static.example.com.conf
server {
	listen 80;
	server_name static.example.com;
	root /usr/local/nginx/html/;
	index static.html;

	location ~* .*\.(png|jpg|gif)$ {
		root /usr/local/nginx/html/images/;		# location配置优先生效
	}
}
[root@web01 ~]# mkdir /usr/local/nginx/html/images/
[root@web01 ~]# wget -O /usr/local/nginx/html/images/nginx.png http://nginx.org/nginx.png
[root@web01 ~]# systemctl restart nginx
```

2. 在web02节点上配置动态资源

```shell
[root@web02 ~]# yum install -y tomcat
[root@web02 ~]# mkdir /usr/share/tomcat/webapps/ROOT/
[root@web02 ~]# vim /usr/share/tomcat/webapps/ROOT/java_test.jsp
<%@ page language="java" import="java.util.*" pageEncoding="utf-8"%>
<HTML>
  <HEAD>
    <TITLE>JSP Test Page</TITLE>
  </HEAD>
  <BODY>
    <%
      Random rand = new Random();
      out.println("<h1>Random number:</h1>");
      out.println(rand.nextInt(99)+100);
    %>
  </BODY>
</HTML>
[root@web02 ~]# systemctl restart tomcat
```

3. 在lb01节点配置代理

```shell
[root@lb01 ~]# vim /etc/nginx/conf.d/lb01_static.conf
upstream static {
	server 172.16.1.7:80;
}

upstream java {
	server 172.16.1.8:8080;
}

server {
	listen 80;
	server_name static.example.com;
	root /usr/local/nginx/html/;
	index index.html;	# 为动态、静态内容准备一个主页

	location ~* .*\.(png|jpg|gif)$ {
		proxy_pass http://static;
		proxy_set_header Host $http_host;
	}

	location ~ \.jsp {
		proxy_pass http://java;
	}
}
```

4. 在lb01节点上准备一个主页

```shell
[root@lb01 ~]# mv /usr/share/nginx/html/index.html /usr/share/nginx/html/index.html.bak
[root@lb01 ~]# vim /usr/share/nginx/html/index.html
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>测试ajax和跨域访问</title>
  <script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
</head>
<script type="text/javascript">
$(document).ready(function(){
	$.ajax({
		type: "GET",
		url: "http://static.example.com/java_test.jsp",
		success: function(data) {
			$("#get_data").html(data)
		},
		error: function(){
			alert("fail!!，请刷新再试！");
		}
	});
});
</script>
  <body>
    <h1>测试动静分离</h1>
    <img src="http://static.example.com/nginx.png">
    <div id="get_data"></div>
  </body>
</html>
```

## Nginx资源分离场景

Nginx通过负载均衡实现安卓、iphone、pc跳转到不同的web节点

|节点|角色|端口|
|---|---|---|
|lb01|负载均衡|80|
|web01|提供Android页面|9090|
|web01|提供iphone页面|9091|
|web01|提供pc页面|9092|

