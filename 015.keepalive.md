# KeepAlive

在单台负载节点的场景下，如果负载节点宕机，则造成整个业务系统的无法访问，所以此时需要多负载节点作为备用；在多负载节点的场景下，如果主负载节点宕机，如何将业务指向到备用负载节点？修改客户端网关IP可以实现，但在客户端数量较多的情况下工作量巨大，直接将备用负载节点IP修改为主节点的IP也无法实现，这与ARP缓存有关，所以此时需要多节点、自动切换的功能

## 高可用VRRP原理

高可用通常是指两台相互之间有探测通信的相同的业务系统，一台故障，另一台能自动接管业务。KeepAlive是一款基于VRRP协议实现高可用功能的软件，VRRP通过软件或硬件的形式在主备双节点之外，增加一个虚拟MAC（VMAC）与虚拟IP（VIP），客户端通过请求VIP的形式访问负载节点，无论是主节点或备节点处理客户请求，客户端都只会在ARP缓存表中记录VMAC和VIP的对应关系

高可用需要解决的问题

- 通过*投票选举、设置优先级*的方式，确定谁是主节点、谁是备节点
- 通过*抢占式、非抢占式*设置，决定主节点故障恢复后是否会抢夺备节点的VIP
- 解决两个节点都认为自身是主节点的问题（脑裂）

### KeepAlive安装

1. 实践环境

|主机名|IP|角色|
|---|---|---|
|lb01|10.0.0.5|Master|
|lb02|10.0.0.6|Backup|
|VIP|10.0.0.2||

2. 在lb节点上安装keepalived

```shell
# lb01
yum install -y keepalived
rpm -qc keepalived	# 查看配置文件存放路径
vim /etc/keepalived/keepalived.conf
global_defs {	# 全局配置
	router_id lb01	# 表示身份名称
}

vrrp_instance VI_1 {
	state MASTER	# 标识角色。仅作为一个标识，没有实际作用，真正的角色选择要看优先级
	interface eth1	# 网卡绑定接口
	virtual_router_id 50	# 虚拟路由id，一个网络环境下存在多个keepalived时，通过这个id号来区分keepalive分组
	priority 150	# 优先级
	advert_int 1	# 主备节点检测间隔时间
	authentication {	# 认证
		auth_type PASS	# 明文认证
		auth_pass 1111	# 明文密码
	}
	virtual_ipaddress {	# VIP地址，可以配置多个
		10.0.0.2
	}
}

# lb02

vim /etc/keepalived/keepalived.conf
global_defs {
	router_id lb02	# 备节点身份名称
}

vrrp_instance VI_1 {
	state SLAVE	# 备节点角色
	interface eth1
	virtual_router_id 50
	priority 149	# 优先级需要比主节点低
	advert_int 1
	authentication {
		auth_type PASS	# 明文认证
		auth_pass 1111	# 主备节点密码必须一致
	}
	virtual_ipaddress {
		10.0.0.2
	}
}

```

KeepAlive的日志默认写入`/var/log/message`，通过`/etc/keepalived/`配置文件能够看到；监视lb02节点的message日志的同时启动keepalived，可以看到keepalived读取了配置文件，并因为没有找到优先级更高的角色而主动获取VIP，此时再启动lb01节点的keepalived，lb02日志因为检测到更高优先级的角色而让出VIP；由此可见KeepAlived默认使用抢占式VIP，抢占式在业务高峰期可能会出现客户端频繁切换网关的情况，影响使用体验

### KeepAlived抢占式与非抢占式

默认情况下，Master节点故障后Backup节点会自动接管Master节点的工作并成为Master，但Master节点恢复后它本身会抢占VIP，这在业务繁忙的时间段可能会造成一定的网络波动

```shell
# lb01

vrrp_instance VI_1 {
	...
	nopreempt	# 主节点添加非抢占参数
	...
}
```